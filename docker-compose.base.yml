version: '3.8'

# ============================================================================
# BASE INFRASTRUCTURE - Shared by ALL modes and environments
# ============================================================================
#
# This file contains ALL infrastructure services that are shared across:
# - Mode 1: Local development (app runs natively)
# - Mode 2: DEV/STAGE/PROD releases (app runs in Docker)
#
# Usage Examples:
#   Mode 1: docker compose -f docker-compose.base.yml up -d
#           Then run: make dev (app natively)
#
#   Mode 2 DEV: docker compose -f docker-compose.base.yml -f docker-compose.app.dev.yml up -d
#   Mode 2 STAGE: docker compose -f docker-compose.base.yml -f docker-compose.app.stage.yml up -d
#   Mode 2 PROD: docker compose -f docker-compose.base.yml -f docker-compose.app.prod.yml up -d
# ============================================================================

services:
  # ==========================================================================
  # CORE INFRASTRUCTURE - Always Required
  # ==========================================================================

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: shia-chatbot-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-shia_chatbot}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Redis Cache & Message Broker
  redis:
    image: redis:7.2-alpine
    container_name: shia-chatbot-redis
    command: redis-server --appendonly yes --appendfsync everysec --maxmemory 1gb --maxmemory-policy allkeys-lru
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: shia-chatbot-qdrant
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=${QDRANT_LOG_LEVEL:-INFO}
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/127.0.0.1/6333'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==========================================================================
  # OPTIONAL SERVICES - Can be disabled if not needed
  # ==========================================================================

  # MinIO Object Storage (S3-compatible)
  minio:
    image: minio/minio:latest
    container_name: shia-chatbot-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_REGION: ${MINIO_REGION:-us-east-1}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"      # S3 API
      - "${MINIO_CONSOLE_PORT:-9001}:9001"  # Web Console
    volumes:
      - minio_data:/data
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  # ==========================================================================
  # MONITORING STACK - Production monitoring
  # ==========================================================================

  # Prometheus Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: shia-chatbot-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./grafana/prometheus-scrape-config.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M

  # Grafana Dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: shia-chatbot-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3000}
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - chatbot-network
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # ==========================================================================
  # REVERSE PROXY - Load Balancer and SSL Termination
  # ==========================================================================

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: shia-chatbot-nginx
    ports:
      - "${NGINX_HTTP_PORT:-8100}:80"    # HTTP (8100 to avoid conflict with other containers)
      - "${NGINX_HTTPS_PORT:-8443}:443"  # HTTPS (8443 to avoid conflict)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - chatbot-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  chatbot-network:
    driver: bridge
    name: shia-chatbot-network

# ============================================================================
# VOLUMES - Persistent Data
# ============================================================================
volumes:
  postgres_data:
    name: shia-chatbot-postgres-data
  redis_data:
    name: shia-chatbot-redis-data
  qdrant_data:
    name: shia-chatbot-qdrant-data
  minio_data:
    name: shia-chatbot-minio-data
  prometheus_data:
    name: shia-chatbot-prometheus-data
  grafana_data:
    name: shia-chatbot-grafana-data
  nginx_logs:
    name: shia-chatbot-nginx-logs
