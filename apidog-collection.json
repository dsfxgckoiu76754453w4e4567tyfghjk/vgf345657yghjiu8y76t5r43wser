{
  "info": {
    "name": "WisQu Islamic Chatbot API",
    "_postman_id": "wisqu-api-collection",
    "description": "Production-grade RAG chatbot with OpenRouter, Google OAuth, and advanced AI features\n\nFeatures:\n- OpenRouter as primary LLM and web search provider\n- SSE streaming for token-by-token responses\n- 2-stage retrieval (vector search + reranking)\n- Google OAuth with unified accounts\n- Prompt caching and cost optimization",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Authentication",
      "item": [
        {
          "name": "Register with Email/Password",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"user@example.com\",\n  \"password\": \"StrongPass123!\",\n  \"name\": \"Ahmed Ali\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/auth/register",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "auth", "register"]
            },
            "description": "Create new user account with email verification via OTP. OTP code sent via Mailgun (SMTP fallback). 6-digit code valid for 10 minutes."
          },
          "response": []
        },
        {
          "name": "Verify OTP",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"user@example.com\",\n  \"otp_code\": \"123456\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/auth/verify-otp",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "auth", "verify-otp"]
            },
            "description": "Verify OTP code and receive access/refresh tokens"
          },
          "response": []
        },
        {
          "name": "Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"user@example.com\",\n  \"password\": \"StrongPass123!\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/auth/login",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "auth", "login"]
            },
            "description": "Login with email and password"
          },
          "response": []
        },
        {
          "name": "Google OAuth (Authorization Code)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"id_token\": \"ya29.a0AfB_byD...\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/auth/google/auth-code",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "auth", "google", "auth-code"]
            },
            "description": "Login/register using Google OAuth authorization code. Supports unified accounts - same email = ONE user."
          },
          "response": []
        },
        {
          "name": "Google OAuth (ID Token)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"id_token\": \"eyJhbGciOiJSUzI1NiIsImtpZCI6...\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/auth/google/id-token",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "auth", "google", "id-token"]
            },
            "description": "Login/register using Google OAuth ID token. Alternative to authorization code flow."
          },
          "response": []
        },
        {
          "name": "Resend OTP",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"user@example.com\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/auth/resend-otp",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "auth", "resend-otp"]
            },
            "description": "Resend OTP verification code"
          },
          "response": []
        },
        {
          "name": "Refresh Token",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refresh_token\": \"{{refresh_token}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/auth/refresh",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "auth", "refresh"]
            },
            "description": "Refresh access token using refresh token"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Chat",
      "item": [
        {
          "name": "Send Message (Non-Streaming)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"conversation_id\": \"{{conversation_id}}\",\n  \"message\": \"What are the 5 pillars of Islam?\",\n  \"model\": \"anthropic/claude-3.5-sonnet\",\n  \"temperature\": 0.7,\n  \"max_tokens\": 2048,\n  \"enable_caching\": true,\n  \"stream\": false,\n  \"auto_detect_images\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/chat/",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "chat", ""]
            },
            "description": "Send chat message and get complete response. Features: prompt caching, model routing with fallbacks, usage tracking, intent detection (image generation, web search, document search)."
          },
          "response": []
        },
        {
          "name": "Send Message (SSE Streaming)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "text/event-stream"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"conversation_id\": \"{{conversation_id}}\",\n  \"message\": \"Explain the concept of Tawhid\",\n  \"stream\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/chat/",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "chat", ""]
            },
            "description": "Send chat message with Server-Sent Events (SSE) streaming. Get token-by-token responses in real-time.\n\nSSE Response Format:\ndata: {\"type\": \"content\", \"content\": \"token\"}\ndata: {\"type\": \"metadata\", \"message_id\": \"...\", \"usage\": {...}}\n\nEnable SSE mode in Apidog to see streaming."
          },
          "response": []
        },
        {
          "name": "Send Message (Image Generation)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"conversation_id\": \"{{conversation_id}}\",\n  \"message\": \"Generate an image of a beautiful mosque at sunset\",\n  \"auto_detect_images\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/chat/",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "chat", ""]
            },
            "description": "Send message with automatic image generation via intent detection. Response includes generated_image field with URL."
          },
          "response": []
        },
        {
          "name": "Send Message (Structured Output)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"conversation_id\": \"{{conversation_id}}\",\n  \"message\": \"Is fasting obligatory in Islam?\",\n  \"response_schema\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"answer\": {\"type\": \"string\"},\n      \"ruling\": {\n        \"type\": \"string\",\n        \"enum\": [\"obligatory\", \"recommended\", \"permissible\", \"disliked\", \"forbidden\"]\n      },\n      \"confidence\": {\"type\": \"number\", \"minimum\": 0, \"maximum\": 1},\n      \"sources\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}}\n    },\n    \"required\": [\"answer\", \"ruling\", \"confidence\"]\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/chat/structured",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "chat", "structured"]
            },
            "description": "Send message with JSON schema validation for structured output"
          },
          "response": []
        },
        {
          "name": "Send Message (Async - Temporal)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"conversation_id\": \"{{conversation_id}}\",\n  \"message\": \"Explain the history of Islamic caliphates in detail\",\n  \"model\": \"anthropic/claude-3.5-sonnet\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/chat/async",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "chat", "async"]
            },
            "description": "Process chat message asynchronously using Temporal workflow. Returns workflow_id for status checking."
          },
          "response": []
        },
        {
          "name": "Get Workflow Status",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/chat/workflows/:workflow_id",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "chat", "workflows", ":workflow_id"],
              "variable": [
                {
                  "key": "workflow_id",
                  "value": "chat-7d8e9f10-9647-62fg-b76d-g29gd3h12cg9"
                }
              ]
            },
            "description": "Check status of async Temporal workflow"
          },
          "response": []
        },
        {
          "name": "Get Cache Statistics",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/chat/cache-stats/:conversation_id",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "chat", "cache-stats", ":conversation_id"],
              "variable": [
                {
                  "key": "conversation_id",
                  "value": "{{conversation_id}}"
                }
              ]
            },
            "description": "Get prompt caching statistics for a conversation (cache hit rate, savings, etc.)"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Conversations",
      "item": [
        {
          "name": "Create Conversation",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"title\": \"Islamic Jurisprudence Discussion\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/conversations/",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "conversations", ""]
            },
            "description": "Create a new conversation"
          },
          "response": []
        },
        {
          "name": "List Conversations",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/conversations/?limit=20&offset=0",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "conversations", ""],
              "query": [
                {
                  "key": "limit",
                  "value": "20"
                },
                {
                  "key": "offset",
                  "value": "0"
                }
              ]
            },
            "description": "List user's conversations with pagination"
          },
          "response": []
        },
        {
          "name": "Get Conversation",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/conversations/:conversation_id",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "conversations", ":conversation_id"],
              "variable": [
                {
                  "key": "conversation_id",
                  "value": "{{conversation_id}}"
                }
              ]
            },
            "description": "Get conversation details with all messages"
          },
          "response": []
        },
        {
          "name": "Delete Conversation",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/conversations/:conversation_id",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "conversations", ":conversation_id"],
              "variable": [
                {
                  "key": "conversation_id",
                  "value": "{{conversation_id}}"
                }
              ]
            },
            "description": "Delete a conversation and all its messages"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Documents (RAG)",
      "item": [
        {
          "name": "Upload Document",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "file",
                  "type": "file",
                  "src": ""
                },
                {
                  "key": "title",
                  "value": "Sahih Bukhari - Volume 1",
                  "type": "text"
                },
                {
                  "key": "category",
                  "value": "hadith",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{base_url}}/api/v1/documents/upload",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "documents", "upload"]
            },
            "description": "Upload PDF/TXT/DOCX for RAG indexing. Document will be chunked using semantic chunking and embedded with Gemini."
          },
          "response": []
        },
        {
          "name": "Search Documents (2-Stage Retrieval)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"query\": \"What does Islam say about charity?\",\n  \"limit\": 10,\n  \"use_reranker\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/documents/search",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "documents", "search"]
            },
            "description": "Search documents using 2-stage retrieval:\n1. Stage 1: Vector search (Qdrant) retrieves candidates\n2. Stage 2: Reranking (Cohere) refines results\n\nProvides 20-40% quality improvement over single-stage search."
          },
          "response": []
        }
      ]
    },
    {
      "name": "Health & Admin",
      "item": [
        {
          "name": "API Health Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/health",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "health"]
            },
            "description": "Check API health and service connectivity (database, redis, qdrant, temporal)"
          },
          "response": []
        },
        {
          "name": "Get System Statistics (Admin)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/v1/admin/stats",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "admin", "stats"]
            },
            "description": "Get system statistics (admin only): total users, conversations, messages, documents, cache hit rate, etc."
          },
          "response": []
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8000",
      "type": "string"
    },
    {
      "key": "access_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "refresh_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "conversation_id",
      "value": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
      "type": "string"
    }
  ]
}
