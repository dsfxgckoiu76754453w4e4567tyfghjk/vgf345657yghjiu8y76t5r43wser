version: '3.8'

# ============================================================================
# STAGE ENVIRONMENT - Pre-Release Testing with Beta Users
# ============================================================================
#
# All environments (dev/stage/prod) run on the SAME VPS.
# Use this when: Testing pre-release with internal team + selected beta users
#
# Container: shia-chatbot-stage-app
# Port: 8001
# Database: shia_chatbot_stage (isolated)
# Redis DB: 1 (isolated)
#
# Usage:
#   docker compose -f docker-compose.base.yml -f docker-compose.app.stage.yml up -d
#
# ============================================================================

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=stage
    image: shia-chatbot:stage
    container_name: shia-chatbot-stage-app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 3
    ports:
      - "8001:8000"
    env_file:
      - .env
    environment:
      # Environment
      - ENVIRONMENT=stage
      - DEBUG=false
      - LOG_LEVEL=INFO

      # PostgreSQL (isolated: shia_chatbot_stage)
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=shia_chatbot_stage
      - DATABASE_USER=${POSTGRES_USER:-postgres}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - DATABASE_DRIVER=postgresql+asyncpg

      # Redis (isolated: db 1)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=1

      # Qdrant (isolated: stage_ prefix)
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION_PREFIX=stage_

      # MinIO (isolated: stage- prefix)
      - MINIO_HOST=minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET_PREFIX=stage-
      - MINIO_SECURE=false

      # Temporal
      - TEMPORAL_HOST=temporal
      - TEMPORAL_PORT=7233
      - TEMPORAL_NAMESPACE=default
      - TEMPORAL_TASK_QUEUE=wisqu-stage-queue
      - TEMPORAL_ENABLED=true

      # API
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-*}

    networks:
      - chatbot-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      temporal:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '3.0'
          memory: 3G
        reservations:
          cpus: '1.5'
          memory: 1.5G
