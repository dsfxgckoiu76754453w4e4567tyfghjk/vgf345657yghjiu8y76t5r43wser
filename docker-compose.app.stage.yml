version: '3.8'

# ============================================================================
# STAGE ENVIRONMENT - Test Users Environment
# ============================================================================
#
# Purpose: Testing environment for QA and beta users before production
# Environment: ENVIRONMENT=stage
# Container Prefix: shia-chatbot-stage-*
#
# Usage:
#   docker compose -f docker-compose.base.yml -f docker-compose.app.stage.yml up --build -d
#
#   Or use Makefile:
#   make docker-stage
#
# This file EXTENDS docker-compose.base.yml and adds application services.
# Isolated from DEV with separate containers, networks, and volumes.
# ============================================================================

services:
  # ==========================================================================
  # FASTAPI APPLICATION
  # ==========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=stage
    image: shia-chatbot:stage
    container_name: shia-chatbot-stage-app
    command: uvicorn src.app.main:app --host 0.0.0.0 --port 8000 --workers 3
    ports:
      - "8001:8000"  # Different external port to avoid conflict with DEV
    volumes:
      - ./src:/app/src:ro
      - ./alembic:/app/alembic:ro
    env_file:
      - .env.stage  # Use stage-specific env file
    environment:
      # ======================================================================
      # ENVIRONMENT ISOLATION - STAGE
      # ======================================================================
      - ENVIRONMENT=stage

      # ======================================================================
      # PostgreSQL Configuration (Clean Multi-Parameter)
      # ======================================================================
      # TRUE ISOLATION: Separate database for STAGE environment
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=shia_chatbot_stage
      - DATABASE_USER=${POSTGRES_USER:-postgres}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - DATABASE_DRIVER=postgresql+asyncpg
      - DATABASE_POOL_SIZE=10
      - DATABASE_MAX_OVERFLOW=20

      # ======================================================================
      # Redis Configuration (Clean Multi-Parameter)
      # ======================================================================
      # TRUE ISOLATION: Separate database number for STAGE (db 1)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=1
      - REDIS_PASSWORD=
      - REDIS_MAX_CONNECTIONS=50

      # ======================================================================
      # Qdrant Configuration (Clean Multi-Parameter)
      # ======================================================================
      # TRUE ISOLATION: Separate collection prefix for STAGE (stage_*)
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_GRPC_PORT=6334
      - QDRANT_COLLECTION_PREFIX=stage_
      - QDRANT_API_KEY=

      # ======================================================================
      # MinIO Configuration (Clean Multi-Parameter)
      # ======================================================================
      # TRUE ISOLATION: Separate bucket prefix for STAGE (stage-*)
      - MINIO_HOST=minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET_PREFIX=stage-
      - MINIO_SECURE=false
      - MINIO_REGION=us-east-1

      # ======================================================================
      # Application Configuration
      # ======================================================================
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG=false
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-*}
    networks:
      - chatbot-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
        reservations:
          cpus: '1.0'
          memory: 1G

  # ==========================================================================
  # CELERY WORKER - Background Task Processing
  # ==========================================================================
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=stage
    image: shia-chatbot:stage
    container_name: shia-chatbot-stage-celery-worker
    command: celery -A app.tasks worker --loglevel=info --concurrency=4
    env_file:
      - .env.stage
    environment:
      - ENVIRONMENT=stage
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=shia_chatbot_stage
      - DATABASE_USER=${POSTGRES_USER:-postgres}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - DATABASE_DRIVER=postgresql+asyncpg
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=1
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION_PREFIX=stage_
      - MINIO_HOST=minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET_PREFIX=stage-
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    networks:
      - chatbot-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      app:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.tasks inspect ping -d celery@$$HOSTNAME"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M

  # ==========================================================================
  # CELERY BEAT - Periodic Task Scheduler
  # ==========================================================================
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=stage
    image: shia-chatbot:stage
    container_name: shia-chatbot-stage-celery-beat
    command: celery -A app.tasks beat --loglevel=info
    env_file:
      - .env.stage
    environment:
      - ENVIRONMENT=stage
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=shia_chatbot_stage
      - DATABASE_USER=${POSTGRES_USER:-postgres}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=1
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - celery_beat_schedule:/app/celerybeat-schedule
    networks:
      - chatbot-network
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 256M

  # ==========================================================================
  # FLOWER - Celery Monitoring Dashboard
  # ==========================================================================
  flower:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=stage
    image: shia-chatbot:stage
    container_name: shia-chatbot-stage-flower
    command: celery -A app.tasks flower --port=5555
    ports:
      - "5556:5555"  # Different external port to avoid conflict with DEV
    env_file:
      - .env.stage
    environment:
      - ENVIRONMENT=stage
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=1
      - FLOWER_BASIC_AUTH=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}
    networks:
      - chatbot-network
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 256M

# ============================================================================
# STAGE-SPECIFIC VOLUMES
# ============================================================================
volumes:
  celery_beat_schedule:
    name: shia-chatbot-stage-celery-beat-schedule

# Note: All infrastructure volumes are inherited from docker-compose.base.yml
