version: '3.8'

# ============================================================================
# DEV ENVIRONMENT - Internal Team Development & Testing
# ============================================================================
#
# All environments (dev/stage/prod) run on the SAME VPS.
# Use this when: Deploying backend for frontend team + QA testing
#
# Container: shia-chatbot-dev-app
# Port: 8000
# Database: shia_chatbot_dev (isolated)
# Redis DB: 0 (isolated)
#
# Usage:
#   docker compose -f docker-compose.base.yml -f docker-compose.app.dev.yml up -d
#
# ============================================================================

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=dev
    image: shia-chatbot:dev
    container_name: shia-chatbot-dev-app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 2
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      # Environment
      - ENVIRONMENT=dev
      - DEBUG=true
      - LOG_LEVEL=DEBUG

      # PostgreSQL (isolated: shia_chatbot_dev)
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=shia_chatbot_dev
      - DATABASE_USER=${POSTGRES_USER:-postgres}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - DATABASE_DRIVER=postgresql+asyncpg

      # Redis (isolated: db 0)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0

      # Qdrant (isolated: dev_ prefix)
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION_PREFIX=dev_

      # MinIO (isolated: dev- prefix)
      - MINIO_HOST=minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET_PREFIX=dev-
      - MINIO_SECURE=false

      # Temporal
      - TEMPORAL_HOST=temporal
      - TEMPORAL_PORT=7233
      - TEMPORAL_NAMESPACE=default
      - TEMPORAL_TASK_QUEUE=wisqu-dev-queue
      - TEMPORAL_ENABLED=true

      # API
      - CORS_ORIGINS=*
      - ALLOWED_HOSTS=*

    networks:
      - chatbot-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      temporal:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
