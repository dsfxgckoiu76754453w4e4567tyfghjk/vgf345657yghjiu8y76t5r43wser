version: '3.8'

# ============================================================================
# PRODUCTION ENVIRONMENT - Live Production System
# ============================================================================
#
# Purpose: Production environment for real users
# Environment: ENVIRONMENT=prod
# Container Prefix: shia-chatbot-prod-*
#
# Usage:
#   docker compose -f docker-compose.base.yml -f docker-compose.app.prod.yml up --build -d
#
#   Or use Makefile:
#   make docker-prod
#
# This file EXTENDS docker-compose.base.yml and adds application services.
# Isolated from DEV/STAGE with separate containers, networks, and volumes.
#
# PRODUCTION CONFIGURATION:
# - Debug mode disabled
# - Higher resource limits
# - More workers for better performance
# - Warning-level logging
# - Production-grade security settings
# ============================================================================

services:
  # ==========================================================================
  # FASTAPI APPLICATION
  # ==========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=prod
    image: shia-chatbot:prod
    container_name: shia-chatbot-prod-app
    command: uvicorn src.app.main:app --host 0.0.0.0 --port 8000 --workers 4 --no-access-log
    ports:
      - "8002:8000"  # Different external port to avoid conflict with DEV/STAGE
    # Note: In production, source code is NOT mounted (security)
    env_file:
      - .env.prod  # Use production-specific env file
    environment:
      # Critical: Set environment to PRODUCTION
      - ENVIRONMENT=prod

      # Database connection
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-shia_chatbot}

      # Redis connection
      - REDIS_URL=redis://redis:6379/0

      # Qdrant connection
      - QDRANT_URL=http://qdrant:6333

      # MinIO connection (optional)
      - MINIO_URL=http://minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}

      # Logging (WARNING in production)
      - LOG_LEVEL=${LOG_LEVEL:-WARNING}

      # Debug mode DISABLED in production
      - DEBUG=false

      # Production security settings
      - CORS_ORIGINS=${CORS_ORIGINS:-https://yourdomain.com}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-yourdomain.com}
    networks:
      - chatbot-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: always  # Always restart in production
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G

  # ==========================================================================
  # CELERY WORKER - Background Task Processing
  # ==========================================================================
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=prod
    image: shia-chatbot:prod
    container_name: shia-chatbot-prod-celery-worker
    command: celery -A src.app.tasks worker --loglevel=warning --concurrency=8
    env_file:
      - .env.prod
    environment:
      - ENVIRONMENT=prod
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-shia_chatbot}
      - REDIS_URL=redis://redis:6379/0
      - QDRANT_URL=http://qdrant:6333
      - MINIO_URL=http://minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - LOG_LEVEL=${LOG_LEVEL:-WARNING}
    networks:
      - chatbot-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      app:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "celery -A src.app.tasks inspect ping -d celery@$$HOSTNAME"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: always
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G

  # ==========================================================================
  # CELERY BEAT - Periodic Task Scheduler
  # ==========================================================================
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=prod
    image: shia-chatbot:prod
    container_name: shia-chatbot-prod-celery-beat
    command: celery -A src.app.tasks beat --loglevel=warning
    env_file:
      - .env.prod
    environment:
      - ENVIRONMENT=prod
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-shia_chatbot}
      - REDIS_URL=redis://redis:6379/0
      - LOG_LEVEL=${LOG_LEVEL:-WARNING}
    volumes:
      - celery_beat_schedule:/app/celerybeat-schedule
    networks:
      - chatbot-network
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M

  # ==========================================================================
  # FLOWER - Celery Monitoring Dashboard
  # ==========================================================================
  flower:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=prod
    image: shia-chatbot:prod
    container_name: shia-chatbot-prod-flower
    command: celery -A src.app.tasks flower --port=5555 --basic_auth=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}
    ports:
      - "5557:5555"  # Different external port to avoid conflict with DEV/STAGE
    env_file:
      - .env.prod
    environment:
      - ENVIRONMENT=prod
      - REDIS_URL=redis://redis:6379/0
      - FLOWER_BASIC_AUTH=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}
      - FLOWER_URL_PREFIX=${FLOWER_URL_PREFIX:-/flower}
    networks:
      - chatbot-network
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M

# ============================================================================
# PRODUCTION-SPECIFIC VOLUMES
# ============================================================================
volumes:
  celery_beat_schedule:
    name: shia-chatbot-prod-celery-beat-schedule

# Note: All infrastructure volumes are inherited from docker-compose.base.yml
