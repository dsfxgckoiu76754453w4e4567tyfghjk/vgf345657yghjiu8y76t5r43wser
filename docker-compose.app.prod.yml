version: '3.8'

# ============================================================================
# PRODUCTION ENVIRONMENT - Live Service for Real Users
# ============================================================================
#
# ⚠️  CRITICAL: All environments run on the SAME VPS with other prod services!
#
# Before deployment:
#   1. docker ps -a (check no conflicts)
#   2. Verify port 8002 is available
#   3. Check system resources
#
# Container: shia-chatbot-prod-app
# Port: 8002
# Database: shia_chatbot_prod (isolated)
# Redis DB: 2 (isolated)
#
# Usage:
#   docker compose -f docker-compose.base.yml -f docker-compose.app.prod.yml up -d
#
# ============================================================================

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=prod
    image: shia-chatbot:prod
    container_name: shia-chatbot-prod-app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
    ports:
      - "8002:8000"
    env_file:
      - .env.prod
    environment:
      # Environment
      - ENVIRONMENT=prod
      - DEBUG=false
      - LOG_LEVEL=WARNING

      # PostgreSQL (isolated: shia_chatbot_prod)
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=shia_chatbot_prod
      - DATABASE_USER=${POSTGRES_USER:-postgres}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD}
      - DATABASE_DRIVER=postgresql+asyncpg

      # Redis (isolated: db 2)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=2

      # Qdrant (isolated: prod_ prefix)
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION_PREFIX=prod_

      # MinIO (isolated: prod- prefix)
      - MINIO_HOST=minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - MINIO_BUCKET_PREFIX=prod-
      - MINIO_SECURE=false

      # Temporal
      - TEMPORAL_HOST=temporal
      - TEMPORAL_PORT=7233
      - TEMPORAL_NAMESPACE=default
      - TEMPORAL_TASK_QUEUE=wisqu-prod-queue
      - TEMPORAL_ENABLED=true

      # API
      - CORS_ORIGINS=${CORS_ORIGINS}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}

    networks:
      - chatbot-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      temporal:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G
